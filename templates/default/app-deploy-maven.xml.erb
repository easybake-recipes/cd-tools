<?xml version='1.0' encoding='UTF-8'?>
<project>
  <actions/>
  <description><%= @job['id'] %> <%= @deploy_env %> leg <%= @leg %> deploy</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.plugins.throttleconcurrents.ThrottleJobProperty>
      <maxConcurrentPerNode>0</maxConcurrentPerNode>
      <maxConcurrentTotal>0</maxConcurrentTotal>
      <throttleEnabled>false</throttleEnabled>
      <throttleOption>project</throttleOption>
    </hudson.plugins.throttleconcurrents.ThrottleJobProperty>
  </properties>
  <scm class="hudson.scm.NullSCM"/>
  <canRoam>true</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers class="vector"/>
  <concurrentBuild>false</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>#!/bin/bash -x
      if [ $GERRIT_BRANCH == 'master' ]; then
        /var/lib/jenkins/tools/promote.rb &apos;<%= @job['chef_server_url'] %>&apos; &apos;<%= @job['node_name'] %>&apos; &apos;<%= @job['client_key'] %>&apos; &apos;<%= @promote_from %>&apos; &apos;<%= @job['chef_server_url'] %>&apos; &apos;<%= @job['node_name'] %>&apos; &apos;<%= @job['client_key'] %>&apos; &apos;<%= @promote_to %>&apos;
      else
        /var/lib/jenkins/tools/promote.rb &apos;<%= @job['chef_server_url'] %>&apos; &apos;<%= @job['node_name'] %>&apos; &apos;<%= @job['client_key'] %>&apos; "${GERRIT_BRANCH}" &apos;<%= @job['chef_server_url'] %>&apos; &apos;<%= @job['node_name'] %>&apos; &apos;<%= @job['client_key'] %>&apos; "${GERRIT_BRANCH}-<%= @leg %>"
      fi
      </command>
    </hudson.tasks.Shell>
    <hudson.tasks.Shell>
      <command>#!/bin/bash -x
      export CHEF_SERVER_URL=<%= @job['chef_server_url'] %>
      export NODE_NAME=<%= @job['node_name'] %>
      export CLIENT_KEY=<%= @job['client_key'] %>
<%- if @job['winrm'] -%>
      /opt/chef/bin/knife winrm 'chef_environment:<%= @promote_to %> AND role:<%= @job['deployment_role'] %> AND NOT apps_<%= @job['id'] %>_status:inactive' 'chef-client -Fdoc -l debug' -x <%= @job['winrm']['username'] %> -P <%= @job['winrm']['password'] %> -c /var/lib/jenkins/tools/ci-knife.rb -a azurefqdn
<%- else -%>
      if [ $GERRIT_BRANCH == 'master' ]
      then
        # search for node within the target environment with the target role
        /opt/chef/bin/knife exec -E 'search(:node,"chef_environment:<%= @promote_to %> AND role:<%= @job['deployment_role'] %>") == [] ? exit(1) : exit(0)'
        if [ $? -gt 0 ]
        # if we do not find one, create one (need to template this out later)
        then
          # Since CloudStack is insane and the maximum name length is
          # 63 characters we need to truncate here. Bash ${RANDOM}
          # returns a number between 0 and 32767 so we need to allocate
          # 6 characters for the "-" and the number.
          NAME=<%= [@promote_to,@job['deployment_role']].join('-') %> | cut -b 1-57
          NAME=${NAME}-${RANDOM}

          /opt/chef/bin/knife cs server create --no-public-ip \
	    -N ${NAME} --environment <%= @promote_to %> \
            --template centos-6.4-20gb-chef11 --service testnode_2x1ghz_2gb \
            --ssh-user root --identity-file ~/.ssh/vagrant \
            --run-list "role[pipeline-base],role[access-engineering-support],role[<%= @job['deployment_role'] %>]" ${NAME}
	  echo "Waiting for this node to show up in solr / knife search"
	  sleep 10
	 fi
      else
        # search for node within the target environment with the target role
        /opt/chef/bin/knife exec -E 'search(:node,"chef_environment:#{ENV[:GERRIT_BRANCH.to_s]}-<%= @leg %> AND role:<%= @job['deployment_role'] %>") == [] ? exit(1) : exit(0)'
        if [ $? -gt 0 ]
        # if we do not find one, create one (need to template this out later)
        then
          # See above fort the explanation of this madness.
          NAME=${GERRIT_BRANCH}-<%= @leg %>-<%= @job['deployment_role'] %> | cut -b 1-57
          NAME=${NAME}-${RANDOM}

          /opt/chef/bin/knife cs server create --no-public-ip \
	    -N ${NAME} --environment ${GERRIT_BRANCH}-<%= @leg %> \
            --template centos-6.4-20gb-chef11 --service testnode_2x1ghz_2gb \
            --ssh-user root --identity-file ~/.ssh/vagrant \
            --run-list "role[pipeline-base],role[access-engineering-support],role[<%= @job['deployment_role'] %>]" ${NAME}
	  echo "Waiting for this node to show up in solr / knife search"
	  sleep 10
	 fi
      fi
<%- end -%>
  </command>

    </hudson.tasks.Shell>

    <hudson.tasks.Shell>
      <command>#!/bin/bash -x
export CHEF_SERVER_URL=<%= @job['chef_server_url'] %>
export NODE_NAME=<%= @job['node_name'] %>
export CLIENT_KEY=<%= @job['client_key'] %>
<%- if @job['winrm'] -%>
      /opt/chef/bin/knife winrm 'chef_environment:<%= @promote_to %> AND role:<%= @job['deployment_role'] %> AND NOT apps_<%= @job['id'] %>_status:inactive' 'chef-client -Fdoc -l debug' -x <%= @job['winrm']['username'] %> -P <%= @job['winrm']['password'] %> -c /var/lib/jenkins/tools/ci-knife.rb -a azurefqdn
<%- else -%>
      if [ $GERRIT_BRANCH == 'master' ]; then
      /opt/chef/bin/knife ssh 'chef_environment:<%= @promote_to %> AND role:<%= @job['deployment_role'] %> AND NOT apps_<%= @job['id'] %>_status:inactive' 'chef-client -Fdoc -l debug' -x root -a ipaddress -c /var/lib/jenkins/tools/ci-knife.rb --no-host-key-verify
      else
      /opt/chef/bin/knife ssh "chef_environment:${GERRIT_BRANCH}-<%= @leg %> AND role:<%= @job['deployment_role'] %> AND NOT apps_<%= @job['id'] %>_status:inactive" 'chef-client -Fdoc -l debug' -x root -a ipaddress -c /var/lib/jenkins/tools/ci-knife.rb --no-host-key-verify
      fi
<%- end -%>
  </command>

    </hudson.tasks.Shell>
    <hudson.tasks.Shell>
      <command>#!/bin/bash -x
export CHEF_SERVER_URL=<%= @job['chef_server_url'] %>
export NODE_NAME=<%= @job['node_name'] %>
export CLIENT_KEY=<%= @job['client_key'] %>
if [ $GERRIT_BRANCH == 'master' ]; then
/var/lib/jenkins/tools/watch_deploy.rb <%= @promote_to %> <%= @job['id'] %> <%= @job['deployment_role'] %> <%= @job['deployment_watch_interval'] %> <%= @job['deployment_watch_timeout'] %>
else
/var/lib/jenkins/tools/watch_deploy.rb ${GERRIT_BRANCH}-<%= @leg %> <%= @job['id'] %> <%= @job['deployment_role'] %> <%= @job['deployment_watch_interval'] %> <%= @job['deployment_watch_timeout'] %>
fi
</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers/>
  <buildWrappers/>
</project>
